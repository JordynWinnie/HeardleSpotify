@page "/guess"
@using System.Net.Http.Headers
@inject IJSRuntime Js
@using Data
@inject IConfiguration Configuration

@inject IHttpClientFactory ClientFactory

<PageTitle>Niji-Guess-Saki</PageTitle>

<head>

</head>
@if (song != null)
{

    <body class="font-body">

        <p>Current Play Period: @CurrentTime seconds</p>
        <p>Song Started From: @SongPlaysFrom </p>
        <input type="range" min="0" max="100" @bind-value=@Volume>
        <br>
        <button onclick="playAudio(@SongPlaysFrom)">
            Play
        </button>
        <br>
        <button @onclick="@(() => RevealSong())">
            Reveal Song
        </button>
        <br>
        <button @onclick="IncreaseTime">Increase Time</button>
        <br>
        <button @onclick="RefreshSong">Refresh Song</button>
        <br>
        <PlayerComponent MinSeconds=0.0 MaxSeconds=30.0 CurrentTime=@CurrentPlayTime></PlayerComponent>
        @if (showSong)
        {
            <SongComponent song=@song></SongComponent>

        }

        <audio id="audioPlayer" @ontimeupdate="TimeUpdate" controls="controls"></audio>
    </body>

}
@code {
    public double CurrentTime = 1.0;
    public double CurrentPlayTime = 0.0;
    private int volume = 15;
    public int Volume
    {
        get
        {
            return volume;
        }
        set
        {
            volume = value;
            SetAudioVolume(value);

        }
    }
    private Song _song = new Song();
    public Song song
    {
        get
        {
            return _song;
        }
        set
        {
            _song = value;
            LoadAudio(_song.track!.preview_url!);
        }
    }

    public SpotifyPlaylist? playListItems = null;
    public bool showSong { get; set; } = false;


    public int SongPlaysFrom { get; set; } = 0;
    bool IsPlaying { get; set; }

    //private ElementReference Audio { get; set; }

    protected async override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            //Authentication for Playlist:
            var client_id = Configuration.GetSection("NGSClientId").Value;
            var client_secret = Configuration.GetSection("NGSClientSecret").Value;

            var content = new FormUrlEncodedContent(new[] { new KeyValuePair<string, string>("grant_type", "client_credentials") });
            var authenticationString =
            Convert.ToBase64String(System.Text.ASCIIEncoding.ASCII.GetBytes($"{client_id}:{client_secret}"));

            var bearerTokenRequest = new HttpRequestMessage(HttpMethod.Post, "https://accounts.spotify.com/api/token");
            bearerTokenRequest.Headers.Authorization = new AuthenticationHeaderValue("Basic", authenticationString);
            bearerTokenRequest.Content = content;
            var client = ClientFactory.CreateClient();
            var result = await client.SendAsync(bearerTokenRequest);
            var token = await result.Content.ReadFromJsonAsync<SpotifyToken>();


            // Get Song:
            var playList_id = "7ulKXEl7j07T22foLPNzvU";
            var songRequest = new HttpRequestMessage(HttpMethod.Get,
            $"https://api.spotify.com/v1/playlists/{playList_id}/tracks?fields=items(track(name%2Cid%2Cpreview_url%2Cartists(name)%2Calbum(images%2Cname)))");
            songRequest.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token?.access_token);
            var loveliveItem = await client.SendAsync(songRequest);
            playListItems = await loveliveItem.Content.ReadFromJsonAsync<SpotifyPlaylist>();


            var randomSongNum = Random.Shared.Next(0, playListItems!.items!.Length);
            var randomSong = playListItems.items[randomSongNum]!;
            SongPlaysFrom = Random.Shared.Next(0, 25);
            CurrentPlayTime = SongPlaysFrom;
            song = randomSong;
            StateHasChanged();
            SetAudioVolume(volume);
        }

        base.OnAfterRender(firstRender);
    }

    private void SetAudioVolume(int volume)
    {
        var newVol = volume / 100.0f;
        Js.InvokeVoidAsync("setVolume", newVol).GetAwaiter();
    }
    private void PlayAudio(float startDuration)
    {
        Js.InvokeVoidAsync("playAudio", startDuration).GetAwaiter();
    }

    private void LoadAudio(string sourceLink)
    {
        Console.WriteLine("Force Audio Load");
        Js.InvokeVoidAsync("loadAudio", sourceLink).GetAwaiter();
    }



    private void StopAudio() =>
    Js.InvokeVoidAsync("stopAudio").GetAwaiter();

    public void IncreaseTime()
    {
        CurrentTime += 0.5f;
    }
    public void RefreshSong()
    {
        Random rnd = new Random();
        var randomSongNum = rnd.Next(0, playListItems!.items!.Length);
        var randomSong = playListItems.items[randomSongNum]!;

        song = randomSong;

        showSong = false;
        CurrentTime = 0.5f;
        SongPlaysFrom = rnd.Next(0, 25);
        CurrentPlayTime = SongPlaysFrom;
        StopAudio();
    }

    public void RevealSong()
    {
        showSong = !showSong;

        CurrentTime = 30.0f;
        if (showSong)
            PlayAudio(0.0f);
        else
            StopAudio();

    }
    private async void TimeUpdate(EventArgs e)
    {
        var result = await Js.InvokeAsync<string>("returnDuration");

        var time = double.Parse(result);

        if (time == 0)
        {
            return;
        }

        CurrentPlayTime = time;
    }

}
